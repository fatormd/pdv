rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // O caminho base do seu aplicativo
    match /artifacts/{appId}/public/data {

      // --- FUNÇÕES AUXILIARES (Helpers) ---
      function isAuthenticated() {
        return request.auth != null;
      }

      function isStaff() {
        return isAuthenticated() && request.auth.token.firebase.sign_in_provider != 'anonymous';
      }

      function isGerente() {
        return isStaff() && 
          get(/databases/$(database)/documents/artifacts/$(appId)/public/data/users/$(request.auth.token.email)).data.role == 'gerente';
      }

      // --- REGRAS DAS COLEÇÕES ---

      // 1. STATUS DO SISTEMA & CONFIGURAÇÕES GERAIS
      match /system_status/{docId} {
        allow read: if isAuthenticated();
        allow write: if isGerente();
      }
      
      match /financial_goals/{docId} {
        allow read: if isStaff();
        allow write: if isGerente();
      }

      // 2. SETORES (Mesas)
      match /sectors/{sectorId} {
        allow read: if isAuthenticated();
        allow write: if isGerente();
      }

      // 3. KDS (PEDIDOS DA COZINHA)
      match /kds_orders/{orderId} {
        allow read, write: if isAuthenticated();
      }

      // 4. PRODUTOS E CATEGORIAS
      match /categories/{categoryId} {
        allow read: if isAuthenticated();
        allow write: if isGerente();
      }
      match /products/{productId} {
        allow read: if isAuthenticated();
        allow write: if isGerente();
      }

      // 5. VOUCHERS E OBSERVAÇÕES
      match /vouchers/{voucherId} {
        allow read: if isAuthenticated();
        allow write: if isGerente();
      }
      match /quick_obs/{obsId} {
        allow read: if isAuthenticated();
        allow write: if isStaff(); 
      }

      // 6. USUÁRIOS (STAFF)
      match /users/{userId} {
        allow read: if isStaff();
        allow write: if false; 
      }

      // 7. MESAS (CORE)
      match /tables/{tableId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        
        allow update: if isAuthenticated() && (
          isStaff() || 
          resource.data.clientId == request.auth.uid ||
          request.resource.data.keys().subsetOf([
            'tableNumber', 'status', 'diners', 'sector', 'createdAt', 'total', 
            'clientId', 'clientName', 'clientPhone', 'anonymousUid', 'clientDocType',
            'selectedItems', 'requestedOrders', 'sentItems', 
            'clientOrderPending', 'waiterNotification', 'billRequested', 
            'payments', 'serviceTaxApplied', 
            'accessPin', 'lastKdsSentAt', 'masterTable', 'mergedTables', 'waiterId',
            'closedAt', 'finalTotal', 'wooOrderId', 'closedBy', 'kdsAlert', 'isPickup', 'note'
          ])
        );
        allow delete: if isStaff();
      }
      
      // 8. CLIENTES (CRM)
      match /customers/{customerId} {
        allow read, write: if isStaff();
        allow read, write: if request.auth.uid == customerId;
      }

      // 9. TURNOS DE CAIXA (SHIFTS)
      match /shifts/{shiftId} {
        allow read, update: if isStaff() && resource.data.userId == request.auth.token.email;
        allow create: if isStaff() && request.resource.data.userId == request.auth.token.email;
        allow read, write: if isGerente();
      }

      // 10. RELATÓRIOS DIÁRIOS
      match /daily_reports/{reportId} {
        allow read: if isStaff();
        allow write: if isGerente();
      }

      // 11. DESPESAS (FINANCEIRO)
      match /expenses/{expenseId} {
        allow read: if isGerente();
        allow write: if isGerente();
      }

      // 12. INSUMOS (COMPOSIÇÃO)
      match /ingredients/{ingredientId} {
        allow read: if isAuthenticated();
        allow write: if isGerente();
      }

      // 13. FORNECEDORES
      match /suppliers/{supplierId} {
        allow read: if isAuthenticated();
        allow write: if isGerente();
      }

      // 14. BANCO DE TALENTOS (EXTRAS / MOTOBOYS)
      match /external_candidates/{candidateId} {
        allow read: if isAuthenticated();
        allow write: if isGerente();
      }

      // 15. ESTOQUE E MOVIMENTAÇÕES
      match /stock/{itemId} {
        allow read: if isAuthenticated();
        allow write: if isStaff();
      }
      
      match /inventory_movements/{movementId} {
        allow read: if isGerente();
        allow write: if isGerente();
      }

      // 16. TIPOS DE INSUMO (AUXILIAR)
      match /ingredient_types/{docId} {
        allow read: if isAuthenticated();
        allow write: if isGerente();
      }

      // 17. CATEGORIAS DE FORNECEDOR (AUXILIAR)
      match /supplier_categories/{docId} {
        allow read: if isAuthenticated();
        allow write: if isGerente();
      }

      // 18. RESERVAS (NOVA REGRA ADICIONADA)
      match /reservations/{reservationId} {
        allow read: if isStaff();
        allow write: if isStaff();
      }
      
      // Bloqueio padrão (Final dos matches internos)
      match /{document=**} {
        allow read, write: if false;
      }
    } 

    // Configurações Públicas (Fora do bloco /data)
    match /artifacts/{appId}/public/product_config {
      allow read: if isAuthenticated();
      allow write: if isGerente();
    }
  }
}