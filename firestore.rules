// Regras para o Firestore (ATUALIZADAS PARA O EMULADOR)
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // O caminho base para os dados do seu app
    match /artifacts/{appId}/public/data/{document=**} {
      // Nega toda leitura/escrita por padrão no caminho de dados
      allow read, write: if false;
    }
    
    // Caminho específico para as coleções do PDV
    match /artifacts/{appId}/public/data {
    
      // --- REGRA "QUICK_OBS" (CORRIGIDA) ---
      // Lógica: Permite 'read' para QUALQUER usuário autenticado.
      match /quick_obs/{obsId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && 
                       request.auth.token.firebase.sign_in_provider != 'anonymous';
      }

      // --- REGRA "USERS" (STAFF) ---
      match /users/{userId} {
        allow read: if request.auth != null &&
                       request.auth.token.firebase.sign_in_provider != 'anonymous';
        allow write: if false; // Protegido! Apenas as Cloud Functions podem escrever.
      }

      // --- REGRA "TABLES" (CORRIGIDA) ---
      // Lógica: Permite que clientes anônimos atualizem uma lista segura de campos.
      match /tables/{tableId} {
        // Staff tem acesso total
        allow read, write: if request.auth != null && 
                              request.auth.token.firebase.sign_in_provider != 'anonymous';
                              
        // Clientes podem ler a mesa
        allow read: if request.auth != null && 
                      request.auth.token.firebase.sign_in_provider == 'anonymous';
                      
        // Clientes (anônimos) podem ATUALIZAR, desde que
        // SÓ atualizem campos da lista permitida.
        allow update: if request.auth != null &&
                        request.auth.token.firebase.sign_in_provider == 'anonymous' &&
                        request.resource.data.keys().subsetOf([
                          'selectedItems', 
                          'requestedOrders', 
                          'clientOrderPending', 
                          'waiterNotification',
                          'clientName', 
                          'clientId',   
                          'clientDocType',
                          // Adiciona campos que o Staff pode mudar (necessário para a regra)
                          'status', 'diners', 'sector', 'createdAt', 'total', 'sentItems', 
                          'payments', 'serviceTaxApplied', 'accessPin', 'lastKdsSentAt', 
                          'masterTable', 'mergedTables', 'waiterId'
                        ]);
      }
      
      // --- REGRA "CUSTOMERS" (CORRIGIDA) ---
      match /customers/{customerId} {
        // Staff tem acesso total
        allow read, write: if request.auth != null &&
                              request.auth.token.firebase.sign_in_provider != 'anonymous';
        
        // Cliente (anônimo) pode criar/atualizar seu próprio registro
        allow write: if request.auth != null &&
                       request.auth.token.firebase.sign_in_provider == 'anonymous' &&
                       request.resource.data.phone == customerId;
      }
      
      // --- REGRA "KDS" (COZINHA) ---
      match /kds_orders/{orderId} {
        allow read, write: if request.auth != null &&
                              request.auth.token.firebase.sign_in_provider != 'anonymous';
      }
    }
    
    // Regra de bloqueio padrão
    match /artifacts/{appId}/public/data/{document=**} {
      allow read, write: if false;
    }
  }
}