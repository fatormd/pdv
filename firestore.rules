rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- BLOCO PRINCIPAL DO APP ---
    match /artifacts/{appId}/public {

      // --- FUNÇÕES AUXILIARES ---
      function isAuthenticated() {
        return request.auth != null;
      }

      function isStaff() {
        // Usuário Staff é qualquer usuário autenticado que NÃO seja anônimo
        return isAuthenticated() && request.auth.token.firebase.sign_in_provider != 'anonymous';
      }

      function isGerente() {
        // Acesso ao role do gerente
        return isStaff() && 
          get(/databases/$(database)/documents/artifacts/$(appId)/public/data/users/$(request.auth.token.email)).data.role == 'gerente';
      }

      // --- BLOCO DE DADOS ---
      match /data {
        
        // 1. STATUS DO SISTEMA & CONFIGURAÇÕES GERAIS
        match /system_status/{docId} { 
          allow read: if isAuthenticated(); 
          allow write: if isGerente(); 
        }
        
        // Configurações da Loja (Nome, Logo, Horários, etc.)
        match /settings/{docId} { 
          allow read: if isAuthenticated(); 
          allow write: if isGerente(); 
        }
        
        match /financial_goals/{docId} { 
          allow read: if isStaff(); 
          allow write: if isGerente(); 
        }

        // 2. SETORES (Mesas e KDS)
        match /sectors/{sectorId} { 
          allow read: if isAuthenticated(); 
          allow write: if isGerente(); 
        }

        // 3. KDS (PEDIDOS DA COZINHA)
        match /kds_orders/{orderId} {
          allow read: if isAuthenticated(); // Libera leitura para o listener do Cliente e para o Staff
          allow write: if isStaff();       // Apenas Staff pode criar/alterar pedidos KDS
        }

        // 4. PRODUTOS E CATEGORIAS
        match /categories/{categoryId} { 
          allow read: if isAuthenticated(); 
          allow write: if isGerente(); 
        }
        match /products/{productId} { 
          allow read: if isAuthenticated(); 
          allow write: if isGerente(); 
        }
        
        // Sincronização de Produtos (Cache)
        match /products_cache/{productId} { 
          allow read: if isAuthenticated(); 
          allow write: if isGerente(); 
        }

        // 5. VOUCHERS E OBSERVAÇÕES
        match /vouchers/{voucherId} { 
          allow read: if isAuthenticated(); 
          allow write: if isGerente(); 
        }
        match /quick_obs/{obsId} { 
          allow read: if isAuthenticated(); 
          allow write: if isStaff(); 
        }

        // 6. USUÁRIOS (STAFF)
        match /users/{userId} { 
          allow read: if isStaff();
          allow write: if false; // Apenas via Admin SDK (Functions)
        }

        // 7. MESAS (CORE)
        match /tables/{tableId} {
          // Permissão de LEITURA: Aberta para clientes (verem sua mesa) e staff
          allow read: if isAuthenticated();
          
          // Criação: Staff PODE criar OU Cliente PODE criar se vincular seu próprio UID
          allow create: if isStaff() || (isAuthenticated() && request.resource.data.clientId == request.auth.uid); 
          
          // Update: Staff PODE TUDO OU Cliente PODE APENAS SE FOR O CLIENTID DA MESA
          allow update: if isStaff() || (isAuthenticated() && resource.data.clientId == request.auth.uid);

          allow delete: if isGerente();
        }
        
        // 8. CLIENTES (CRM)
        match /customers/{customerId} {
          allow read, write: if isStaff();
          // Cliente pode ler e escrever no seu próprio perfil (auto-cadastro)
          allow read, write: if request.auth.uid == customerId;
        }

        // 9. TURNOS DE CAIXA (SHIFTS)
        match /shifts/{shiftId} { 
          allow read, update: if isStaff() && resource.data.userId == request.auth.token.email; 
          allow create: if isStaff() && request.resource.data.userId == request.auth.token.email; 
          allow read, write: if isGerente(); 
        }

        // 10. RELATÓRIOS DIÁRIOS
        match /daily_reports/{reportId} { 
          allow read: if isStaff(); 
          allow write: if isGerente(); 
        }

        // 11. DESPESAS (FINANCEIRO)
        match /expenses/{expenseId} { 
          allow read: if isGerente(); 
          allow write: if isGerente(); 
        }

        // 12. INSUMOS (COMPOSIÇÃO)
        match /ingredients/{ingredientId} { 
          allow read: if isAuthenticated(); 
          allow write: if isGerente(); 
        }

        // 13. FORNECEDORES
        match /suppliers/{supplierId} { 
          allow read: if isAuthenticated(); 
          allow write: if isGerente(); 
        }

        // 14. BANCO DE TALENTOS
        match /external_candidates/{candidateId} { 
          allow read: if isAuthenticated(); 
          allow write: if isGerente(); 
        }

        // 15. ESTOQUE E MOVIMENTAÇÕES
        match /stock/{itemId} { 
          allow read: if isAuthenticated(); 
          allow write: if isStaff(); 
        }
        
        match /inventory_movements/{movementId} { 
          allow read: if isGerente(); 
          allow write: if isGerente(); 
        }

        // 16. TIPOS DE INSUMO (GRUPOS DE ESTOQUE)
        match /ingredient_types/{docId} { 
          allow read: if isAuthenticated(); 
          allow write: if isGerente(); 
        }

        // 17. CATEGORIAS DE FORNECEDOR
        match /supplier_categories/{docId} { 
          allow read: if isAuthenticated(); 
          allow write: if isGerente(); 
        }

        // 18. RESERVAS (CORRIGIDO AQUI)
        match /reservations/{reservationId} { 
          // PERMITIR CRIAÇÃO: Qualquer usuário autenticado (incluindo Cliente) pode solicitar
          allow create: if isAuthenticated();
          
          // PERMITIR LEITURA: Staff vê tudo, Cliente vê apenas a dele
          allow read: if isStaff() || (isAuthenticated() && resource.data.clientUid == request.auth.uid);
          
          // PERMITIR UPDATE: Apenas Staff (para confirmar/cancelar)
          allow update, delete: if isStaff(); 
        }
        
        // 19. LISTAS DE COMPRAS
        match /shopping_lists/{listId} { 
          allow read: if isStaff(); 
          allow write: if isGerente(); 
        }
        
        // 20. COTAÇÕES DE PREÇO
        match /price_quotations/{quoteId} { 
          allow read: if isStaff(); 
          allow write: if isStaff(); 
        }

        // Bloqueio padrão para qualquer outra coleção não listada
        match /{document=**} {
          allow read, write: if false;
        }
      } 

      // --- CONFIGURAÇÕES PÚBLICAS (Irmão de /data) ---
      match /product_config {
        allow read: if isAuthenticated();
        allow write: if isGerente();
      }
    }
  }
}